name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare deployment
        run: |
          # Debug: Show current directory structure
          echo "Current directory structure before changes:"
          ls -la

          # Create the envelope directory and its subdirectories
          mkdir -p envelope/js

          # Copy all files to the envelope directory
          cp -r assets envelope/
          cp index.html envelope/
          cp -r js/* envelope/js/ || true

          # Create config.js with proper content
          cat > envelope/js/config.js << 'EOL'
          const config = {
            passcode: {
              value: ${{ secrets.PASSCODE }},
              placeholder: "Enter number...",
              errorMessage: "Try again!"
            },
            letter: {
              title: "My Love Letter",
              paragraphs: [
                "Dear love...",
                "You mean everything to me...",
                "Forever yours..."
              ],
              signature: {
                text: "With all my love,",
                name: "Your Secret Admirer"
              }
            }
          };

          // Make config globally available and log its creation
          console.log("Initializing config...");
          window.config = config;
          console.log("Config initialized:", config);

          // Define getConfig function with better error handling
          window.getConfig = function() {
            console.log("getConfig called");
            try {
              if (!window.config) {
                console.error("window.config is not defined");
                throw new Error("Config not found");
              }
              const configCopy = JSON.parse(JSON.stringify(window.config));
              console.log("Returning config:", configCopy);
              return configCopy;
            } catch (error) {
              console.error('Error in getConfig:', error);
              return {
                passcode: {
                  value: 0,
                  placeholder: "Enter number...",
                  errorMessage: "Try again!",
                },
                letter: {
                  title: "",
                  paragraphs: [""],
                  signature: { text: "", name: "" },
                }
              };
            }
          };
          EOL

          # Copy script.js to envelope/js directory
          if [ -f "js/script.js" ]; then
            cp js/script.js envelope/js/
          else
            echo "Warning: script.js not found in js directory"
          fi

          # Debug: Show final directory structure
          echo "Final directory structure:"
          ls -la envelope/
          echo "Contents of envelope/js directory:"
          ls -la envelope/js/
          echo "First few lines of config.js:"
          head -n 5 envelope/js/config.js

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "envelope"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
