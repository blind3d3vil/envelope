name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare deployment
        run: |
          # Debug: Show current directory structure
          echo "Current directory structure before changes:"
          ls -la

          # Ensure the js directory exists
          mkdir -p js

          # Create config.js with proper content
          cat > js/config.js << 'EOL'
          const config = {
            passcode: {
              value: ${{ secrets.PASSCODE }},
              placeholder: "Enter number...",
              errorMessage: "Try again!"
            },
            letter: {
              title: "My Love Letter",
              paragraphs: [
                "Dear love...",
                "You mean everything to me...",
                "Forever yours..."
              ],
              signature: {
                text: "With all my love,",
                name: "Your Secret Admirer"
              }
            }
          };

          // Make config globally available and log its creation
          console.log("Initializing config...");
          window.config = config;
          console.log("Config initialized:", config);

          // Define getConfig function with better error handling
          window.getConfig = function() {
            console.log("getConfig called");
            try {
              if (!window.config) {
                console.error("window.config is not defined");
                throw new Error("Config not found");
              }
              const configCopy = JSON.parse(JSON.stringify(window.config));
              console.log("Returning config:", configCopy);
              return configCopy;
            } catch (error) {
              console.error('Error in getConfig:', error);
              return {
                passcode: {
                  value: 0,
                  placeholder: "Enter number...",
                  errorMessage: "Try again!",
                },
                letter: {
                  title: "",
                  paragraphs: [""],
                  signature: { text: "", name: "" },
                }
              };
            }
          };
          EOL

          # Ensure script.js exists in js directory
          if [ -f "js/script.js" ]; then
            echo "script.js already exists in js directory"
          else
            echo "Copying script.js to js directory"
            cp script.js js/script.js || echo "Failed to copy script.js"
          fi

          # Debug: Show final directory structure
          echo "Final directory structure:"
          ls -la
          echo "Contents of js directory:"
          ls -la js/
          echo "First few lines of config.js:"
          head -n 5 js/config.js
          echo "Checking if script.js exists:"
          ls -la js/script.js || echo "script.js not found"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
