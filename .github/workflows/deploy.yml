name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare deployment files
        env:
          CONFIG_CONTENT: ${{ secrets.CONFIG_JS }}
        run: |
          # Debug: Show initial structure
          echo "Initial directory structure:"
          ls -la

          # Create base directory
          mkdir -p _site

          # Copy everything except .git and _site
          rsync -av --exclude='.git' --exclude='_site' . _site/

          # Create config.js from secret
          echo "$CONFIG_CONTENT" > _site/js/config.js

          # Debug: Show deployment structure
          echo "Final deployment structure:"
          find _site -type f

          # Show file sizes (but not content for security)
          echo "File sizes:"
          for file in _site/index.html _site/js/script.js _site/js/config.js _site/assets/css/styles.css; do
            if [ -f "$file" ]; then
              echo "$file: $(wc -c < "$file") bytes ✅"
            else
              echo "$file: missing ❌"
            fi
          done

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_site"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
