name: Deploy to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare deployment
        run: |
          # Ensure the js directory exists
          mkdir -p js

          # Create config.js with proper content
          cat > js/config.js << 'EOL'
          const config = {
            passcode: {
              value: ${{ secrets.PASSCODE }},
              placeholder: "Enter number...",
              errorMessage: "Try again!"
            },
            letter: {
              title: "My Love Letter",
              paragraphs: [
                "Dear love...",
                "You mean everything to me...",
                "Forever yours..."
              ],
              signature: {
                text: "With all my love,",
                name: "Your Secret Admirer"
              }
            }
          };

          // Make config globally available
          window.config = config;

          // Define getConfig function with better error handling
          window.getConfig = function() {
            console.log("getConfig called");
            try {
              if (!window.config) {
                throw new Error("Config not found");
              }
              return JSON.parse(JSON.stringify(window.config));
            } catch (error) {
              console.error('Error in getConfig:', error);
              return {
                passcode: {
                  value: 0,
                  placeholder: "Enter number...",
                  errorMessage: "Try again!",
                },
                letter: {
                  title: "",
                  paragraphs: [""],
                  signature: { text: "", name: "" },
                }
              };
            }
          };
          EOL

          # Copy script.js to ensure it's in the correct location
          cp js/script.js js/script.js.bak || true

          # Verify file structure and contents
          echo "Checking directory structure:"
          ls -la
          echo "Checking js directory:"
          ls -la js/
          echo "Checking config.js contents:"
          cat js/config.js

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "."

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
